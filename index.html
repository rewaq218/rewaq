<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تسجيل طلاب العلوم الشرعية</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f2f5;
        }
    </style>
</head>
<body>
    <main class="min-h-screen p-4 md:p-8 lg:p-12">
        <div class="max-w-4xl mx-auto bg-white p-6 rounded-lg shadow-md">
            <h1 class="text-2xl md:text-3xl font-bold text-center mb-8">تسجيل بيانات دارسي العلوم الشرعية</h1>

            <form class="space-y-6">
                <!-- البيانات الشخصية -->
                <div class="bg-gray-50 p-4 rounded-md">
                    <h2 class="text-xl font-semibold mb-4">البيانات الشخصية</h2>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-gray-700 mb-1">المحافظة</label>
                            <select
                                name="governorate"
                                required
                                class="w-full p-2 border rounded"
                            >
                                <option value="">اختر المحافظة</option>
                                <option value="القاهرة">القاهرة</option>
                                <option value="الجيزة">الجيزة</option>
                                <option value="الإسكندرية">الإسكندرية</option>
                                <option value="الدقهلية">الدقهلية</option>
                                <option value="البحر الأحمر">البحر الأحمر</option>
                                <option value="البحيرة">البحيرة</option>
                                <option value="الفيوم">الفيوم</option>
                                <option value="الغربية">الغربية</option>
                                <option value="الإسماعيلية">الإسماعيلية</option>
                                <option value="المنوفية">المنوفية</option>
                                <option value="المنيا">المنيا</option>
                                <option value="القليوبية">القليوبية</option>
                                <option value="الوادي الجديد">الوادي الجديد</option>
                                <option value="السويس">السويس</option>
                                <option value="أسوان">أسوان</option>
                                <option value="أسيوط">أسيوط</option>
                                <option value="بني سويف">بني سويف</option>
                                <option value="بورسعيد">بورسعيد</option>
                                <option value="دمياط">دمياط</option>
                                <option value="الشرقية">الشرقية</option>
                                <option value="جنوب سيناء">جنوب سيناء</option>
                                <option value="كفر الشيخ">كفر الشيخ</option>
                                <option value="مطروح">مطروح</option>
                                <option value="الأقصر">الأقصر</option>
                                <option value="قنا">قنا</option>
                                <option value="شمال سيناء">شمال سيناء</option>
                                <option value="سوهاج">سوهاج</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-gray-700 mb-1">الاسم رباعي</label>
                            <input
                                type="text"
                                name="fullName"
                                required
                                class="w-full p-2 border rounded"
                            />
                        </div>

                        <div>
                            <label class="block text-gray-700 mb-1">رقم جواز السفر</label>
                            <input
                                type="text"
                                name="passportNumber"
                                required
                                class="w-full p-2 border rounded"
                            />
                        </div>

                        <div>
                            <label class="block text-gray-700 mb-1">رقم الواتس</label>
                            <input
                                type="text"
                                name="whatsappNumber"
                                required
                                class="w-full p-2 border rounded"
                            />
                        </div>

                        <div>
                            <label class="block text-gray-700 mb-1">النوع</label>
                            <select
                                name="gender"
                                required
                                class="w-full p-2 border rounded"
                            >
                                <option value="">اختر النوع</option>
                                <option value="male">ذكر</option>
                                <option value="female">أنثى</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-gray-700 mb-1">السن</label>
                            <input
                                type="number"
                                name="age"
                                required
                                min="10"
                                class="w-full p-2 border rounded"
                            />
                        </div>

                        <div>
                            <label class="block text-gray-700 mb-1">محل الإقامة</label>
                            <input
                                type="text"
                                name="residence"
                                required
                                class="w-full p-2 border rounded"
                            />
                        </div>
                    </div>
                </div>

                <!-- البيانات التعليمية -->
                <div class="bg-gray-50 p-4 rounded-md">
                    <h2 class="text-xl font-semibold mb-4">البيانات التعليمية</h2>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-gray-700 mb-1">المؤهل الدراسي</label>
                            <input
                                type="text"
                                name="qualification"
                                required
                                class="w-full p-2 border rounded"
                            />
                        </div>

                        <div>
                            <label class="block text-gray-700 mb-1">نوع التعليم</label>
                            <select
                                name="educationType"
                                required
                                class="w-full p-2 border rounded"
                            >
                                <option value="">اختر نوع التعليم</option>
                                <option value="general">عام</option>
                                <option value="azhar">أزهري</option>
                                <option value="other">أخرى</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-gray-700 mb-1">الوظيفة (إن وجدت)</label>
                            <input
                                type="text"
                                name="job"
                                class="w-full p-2 border rounded"
                            />
                        </div>

                        <div>
                            <label class="block text-gray-700 mb-1">السنة الدراسية (خاص بالطلاب)</label>
                            <input
                                type="text"
                                name="academicYear"
                                class="w-full p-2 border rounded"
                            />
                        </div>
                    </div>
                </div>

                <!-- بيانات التسجيل -->
                <div class="bg-gray-50 p-4 rounded-md">
                    <h2 class="text-xl font-semibold mb-4">بيانات التسجيل</h2>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-gray-700 mb-1">الرقم المرجعي</label>
                            <input
                                type="text"
                                name="referenceNumber"
                                required
                                class="w-full p-2 border rounded"
                                placeholder="أدخل الرقم المرجعي الخاص بك"
                            />
                        </div>
                        <div>
                            <label class="block text-gray-700 mb-1">المرحلة المتقدم لها</label>
                            <select
                                name="level"
                                required
                                class="w-full p-2 border rounded"
                                id="levelSelect"
                                onchange="toggleSpecialization()"
                            >
                                <option value="">اختر المرحلة</option>
                                <option value="preparatory">تمهيدية</option>
                                <option value="intermediate">متوسطة</option>
                                <option value="specialized">تخصصية</option>
                            </select>
                        </div>

                        <div id="specializationDiv" style="display: none;">
                            <label class="block text-gray-700 mb-1">التخصص</label>
                            <select
                                name="specialization"
                                class="w-full p-2 border rounded"
                            >
                                <option value="">اختر التخصص</option>
                                <option value="fiqh">فقه</option>
                                <option value="arabic">لغة عربية</option>
                                <option value="creed">العقيدة</option>
                                <option value="tafsir_hadith">تفسير وحديث</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-gray-700 mb-1">المذهب</label>
                            <select
                                name="school"
                                required
                                class="w-full p-2 border rounded"
                            >
                                <option value="">اختر المذهب</option>
                                <option value="maliki">مالكي</option>
                                <option value="hanafi">حنفي</option>
                                <option value="shafii">شافعي</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-gray-700 mb-1">نظام الحضور</label>
                            <select
                                name="attendanceSystem"
                                required
                                class="w-full p-2 border rounded"
                            >
                                <option value="">اختر نظام الحضور</option>
                                <option value="inPerson">مباشر</option>
                                <option value="remote">عن بعد</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-gray-700 mb-1">من ذوي الهمم</label>
                            <select
                                name="specialNeeds"
                                required
                                class="w-full p-2 border rounded"
                            >
                                <option value="">اختر</option>
                                <option value="yes">نعم</option>
                                <option value="no">لا</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- المستندات -->
                <div class="bg-gray-50 p-4 rounded-md">
                    <h2 class="text-xl font-semibold mb-4">المستندات المطلوبة</h2>

                    <div class="grid grid-cols-1 gap-4">
                        <div>
                            <label class="block text-gray-700 mb-1">صورة البطاقة (وجه وظهر)</label>
                            <div class="flex flex-col space-y-2">
                                <input
                                    type="file"
                                    name="idCardImage"
                                    id="idCardImage"
                                    required
                                    class="w-full p-2 border rounded"
                                    accept="image/*"
                                    onchange="previewImage('idCardImage', 'idCardPreview')"
                                />
                                <div id="idCardPreview" class="mt-2 hidden">
                                    <p class="text-sm text-gray-500 mb-1">معاينة الصورة:</p>
                                    <img src="" alt="معاينة صورة البطاقة" class="max-h-40 border rounded shadow-sm" />
                                </div>
                            </div>
                        </div>

                        <div>
                            <label class="block text-gray-700 mb-1">
                                صورة المؤهل
                                <span class="text-sm text-gray-500 mr-1">(مطلوب فقط للمرحلة المتوسطة والتخصصية)</span>
                            </label>
                            <div class="flex flex-col space-y-2">
                                <input
                                    type="file"
                                    name="qualificationImage"
                                    id="qualificationImage"
                                    class="w-full p-2 border rounded"
                                    accept="image/*"
                                    onchange="previewImage('qualificationImage', 'qualificationPreview')"
                                />
                                <div id="qualificationPreview" class="mt-2 hidden">
                                    <p class="text-sm text-gray-500 mb-1">معاينة الصورة:</p>
                                    <img src="" alt="معاينة صورة المؤهل" class="max-h-40 border rounded shadow-sm" />
                                </div>
                            </div>
                        </div>

                        <div>
                            <label class="block text-gray-700 mb-1">صورة إيصال الدفع</label>
                            <div class="flex flex-col space-y-2">
                                <input
                                    type="file"
                                    name="paymentReceiptImage"
                                    id="paymentReceiptImage"
                                    required
                                    class="w-full p-2 border rounded"
                                    accept="image/*"
                                    onchange="previewImage('paymentReceiptImage', 'paymentReceiptPreview')"
                                />
                                <div id="paymentReceiptPreview" class="mt-2 hidden">
                                    <p class="text-sm text-gray-500 mb-1">معاينة الصورة:</p>
                                    <img src="" alt="معاينة صورة إيصال الدفع" class="max-h-40 border rounded shadow-sm" />
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex justify-center">
                    <button
                        type="submit"
                        id="submitButton"
                        class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg text-lg"
                        onclick="submitForm(event)"
                    >
                        تسجيل البيانات
                    </button>
                </div>
            </form>

            <div id="successMessage" class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative mb-6 mt-6" style="display: none;">
                <h2 class="font-bold text-xl mb-2">تم التسجيل بنجاح!</h2>
                <p>الرقم المرجعي الخاص بك: <strong id="referenceNumber"></strong></p>
                <p class="mt-4">يرجى الاحتفاظ بهذا الرقم للرجوع إليه في المستقبل.</p>
                <button
                    onclick="resetForm()"
                    class="mt-4 bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded"
                >
                    تسجيل طالب جديد
                </button>
            </div>
        </div>
    </main>

    <script>
        function toggleSpecialization() {
            const levelSelect = document.getElementById('levelSelect');
            const specializationDiv = document.getElementById('specializationDiv');
            const qualificationImage = document.getElementById('qualificationImage');

            // التعامل مع قسم التخصص
            if (levelSelect.value === 'specialized') {
                specializationDiv.style.display = 'block';
                specializationDiv.querySelector('select').required = true;
            } else {
                specializationDiv.style.display = 'none';
                specializationDiv.querySelector('select').required = false;
            }

            // التعامل مع حقل صورة المؤهل
            if (levelSelect.value === 'intermediate' || levelSelect.value === 'specialized') {
                qualificationImage.required = true;
            } else {
                qualificationImage.required = false;
            }
        }

        // وظيفة معاينة الصور
        function previewImage(inputId, previewId) {
            const input = document.getElementById(inputId);
            const preview = document.getElementById(previewId);
            const previewImg = preview.querySelector('img');

            if (input.files && input.files[0]) {
                const reader = new FileReader();

                reader.onload = function(e) {
                    previewImg.src = e.target.result;
                    preview.classList.remove('hidden');
                }

                reader.readAsDataURL(input.files[0]);
            } else {
                previewImg.src = '';
                preview.classList.add('hidden');
            }
        }

        async function submitForm(event) {
            event.preventDefault();

            // إظهار مؤشر التحميل
            document.getElementById('submitButton').disabled = true;
            document.getElementById('submitButton').textContent = 'جاري التسجيل...';

            try {
                // الحصول على الرقم المرجعي الذي أدخله المستخدم
                const referenceNumber = document.querySelector('input[name="referenceNumber"]').value;

                // التحقق من وجود الرقم المرجعي
                const checkResult = await checkReferenceNumber(referenceNumber);
                if (checkResult.success && checkResult.exists) {
                    alert('هذا الرقم المرجعي مستخدم بالفعل. الرجاء استخدام رقم مرجعي آخر.');
                    document.getElementById('submitButton').disabled = false;
                    document.getElementById('submitButton').textContent = 'تسجيل البيانات';
                    return;
                }

                // جمع بيانات النموذج
                const formData = {
                    governorate: document.querySelector('select[name="governorate"]').value,
                    full_name: document.querySelector('input[name="fullName"]').value,
                    passport_number: document.querySelector('input[name="passportNumber"]').value,
                    whatsapp_number: document.querySelector('input[name="whatsappNumber"]').value,
                    gender: document.querySelector('select[name="gender"]').value,
                    age: parseInt(document.querySelector('input[name="age"]').value),
                    residence: document.querySelector('input[name="residence"]').value,
                    qualification: document.querySelector('input[name="qualification"]').value,
                    education_type: document.querySelector('select[name="educationType"]').value,
                    job: document.querySelector('input[name="job"]').value || null,
                    academic_year: document.querySelector('input[name="academicYear"]').value || null,
                    level: document.querySelector('select[name="level"]').value,
                    specialization: document.querySelector('select[name="level"]').value === 'specialized' ?
                                    document.querySelector('select[name="specialization"]').value : null,
                    school: document.querySelector('select[name="school"]').value,
                    attendance_system: document.querySelector('select[name="attendanceSystem"]').value,
                    special_needs: document.querySelector('select[name="specialNeeds"]').value,
                    reference_number: referenceNumber,
                    created_at: new Date().toISOString()
                };

                // رفع الملفات
                const idCardFile = document.querySelector('input[name="idCardImage"]').files[0];
                const qualificationFile = document.querySelector('input[name="qualificationImage"]').files[0];
                const paymentReceiptFile = document.querySelector('input[name="paymentReceiptImage"]').files[0];

                if (idCardFile) {
                    const idCardPath = `${referenceNumber}/id_card.${idCardFile.name.split('.').pop()}`;
                    const idCardUpload = await uploadFile(idCardFile, idCardPath);
                    if (idCardUpload.success) {
                        formData.id_card_url = idCardUpload.url;
                    }
                }

                if (qualificationFile) {
                    const qualificationPath = `${referenceNumber}/qualification.${qualificationFile.name.split('.').pop()}`;
                    const qualificationUpload = await uploadFile(qualificationFile, qualificationPath);
                    if (qualificationUpload.success) {
                        formData.qualification_url = qualificationUpload.url;
                    }
                }

                if (paymentReceiptFile) {
                    const paymentReceiptPath = `${referenceNumber}/payment_receipt.${paymentReceiptFile.name.split('.').pop()}`;
                    const paymentReceiptUpload = await uploadFile(paymentReceiptFile, paymentReceiptPath);
                    if (paymentReceiptUpload.success) {
                        formData.payment_receipt_url = paymentReceiptUpload.url;
                    }
                }

                // حفظ البيانات في قاعدة البيانات
                const saveResult = await saveStudent(formData);

                if (saveResult.success) {
                    // عرض الرقم المرجعي في رسالة النجاح
                    document.getElementById('referenceNumber').textContent = referenceNumber;

                    // إظهار رسالة النجاح
                    document.querySelector('form').style.display = 'none';
                    document.getElementById('successMessage').style.display = 'block';
                } else {
                    alert('حدث خطأ أثناء حفظ البيانات. الرجاء المحاولة مرة أخرى.');
                    console.error(saveResult.error);
                }
            } catch (error) {
                alert('حدث خطأ غير متوقع. الرجاء المحاولة مرة أخرى.');
                console.error(error);
            } finally {
                // إعادة تفعيل زر التقديم
                document.getElementById('submitButton').disabled = false;
                document.getElementById('submitButton').textContent = 'تسجيل البيانات';
            }
        }

        function resetForm() {
            document.querySelector('form').reset();
            document.querySelector('form').style.display = 'block';
            document.getElementById('successMessage').style.display = 'none';

            // إعادة ضبط حقل التخصص
            toggleSpecialization();

            // إعادة ضبط معاينات الصور
            document.getElementById('idCardPreview').classList.add('hidden');
            document.getElementById('qualificationPreview').classList.add('hidden');
            document.getElementById('paymentReceiptPreview').classList.add('hidden');
        }
        // استدعاء الوظيفة عند تحميل الصفحة
        document.addEventListener('DOMContentLoaded', function() {
            toggleSpecialization();
        });
    </script>
</body>
</html>
